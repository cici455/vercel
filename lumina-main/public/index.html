<!DOCTYPE html><html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>LUMINA v7 | Celestial Breath</title>

<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
    body { background-color: #000000; color: #e2e8f0; overflow: hidden; font-family: 'Inter', sans-serif; }
    .font-display { font-family: 'Space Grotesk', sans-serif; }
    
    /* 氛围层 */
    .noise-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        opacity: 0.05;
    }
    .vignette {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40;
        background: radial-gradient(circle at center, transparent 40%, #000000 120%);
    }

    /* 玻璃面板 */
    .glass-panel {
        background: rgba(10, 10, 15, 0.6); backdrop-filter: blur(24px);
        border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 60px rgba(0, 0, 0, 0.6);
    }
    .glass-btn {
        background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.4s ease-out; position: relative; overflow: hidden;
    }
    .glass-btn:hover {
        border-color: rgba(255,255,255,0.4); box-shadow: 0 0 30px rgba(255,255,255,0.1); background: rgba(255, 255, 255, 0.08);
    }
    
    /* 输入框通用 */
    .input-glass {
        background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.15); color: white; transition: 0.3s;
    }
    .input-glass:focus { border-color: rgba(255, 255, 255, 0.4); background: rgba(0,0,0,0.6); outline: none; }
    
    /* 隐藏滚动条 */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    /* 隐藏数字输入框箭头 */
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    
    .glow-gold { text-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
    .text-outline { -webkit-text-stroke: 1px rgba(255,255,255,0.1); color: transparent; }
</style>
</head> <body> <div id="root"></div> <div class="noise-overlay"></div> <div class="vignette"></div> <canvas id="canvas3d" class="fixed top-0 left-0 w-full h-full -z-10"></canvas>

<script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { motion, AnimatePresence } = window.Motion;

    // ==========================================
    // 1. 背景系统：平和的呼吸 (Peaceful Breath)
    // ==========================================
    const ConstellationBackground = () => {
        useEffect(() => {
            const canvas = document.getElementById('canvas3d');
            const ctx = canvas.getContext('2d');
            let width = window.innerWidth, height = window.innerHeight;
            canvas.width = width; canvas.height = height;

            const PARTICLE_COUNT = 1000;
            
            // 粒子定义
            const particles = Array.from({ length: PARTICLE_COUNT }, () => ({
                x: Math.random() * width,
                y: Math.random() * height,
                tx: Math.random() * width, // Target X
                ty: Math.random() * height, // Target Y
                vx: 0, vy: 0,
                size: Math.random() * 1.5,
                color: Math.random() > 0.85 ? {r:251, g:191, b:36} : {r:200, g:220, b:255}, // 金色 & 冷白
                baseX: Math.random() * width, // 散开时的基准位置
                baseY: Math.random() * height
            }));

            // 星座形状生成器 (归一化坐标)
            const ZodiacShapes = {
                ARIES: (i) => { // 白羊座形状
                    const points = [[0.2,0.6],[0.35,0.5],[0.5,0.45],[0.65,0.5],[0.75,0.65]];
                    const pt = points[i % points.length];
                    return { x: pt[0], y: pt[1] };
                },
                TAURUS: (i) => { // 金牛座 V形
                    const points = [[0.5,0.8],[0.5,0.6],[0.3,0.4],[0.7,0.4],[0.2,0.25],[0.8,0.25]];
                    const pt = points[i % points.length];
                    return { x: pt[0], y: pt[1] };
                },
                LEO: (i) => { // 狮子座 问号形
                    const points = [[0.3,0.3],[0.4,0.2],[0.55,0.2],[0.65,0.35],[0.6,0.5],[0.45,0.6],[0.35,0.7]];
                    const pt = points[i % points.length];
                    return { x: pt[0], y: pt[1] };
                }
            };
            
            const signs = ['ARIES', 'TAURUS', 'LEO'];
            let signIndex = 0;
            let state = 'DISPERSED'; // 状态机：DISPERSED -> GATHERING -> DISPERSED
            let lastStateChange = 0;
            let mouse = { x: -9999, y: -9999 };

            function updateTargets() {
                particles.forEach((p, i) => {
                    if (state === 'GATHERING') {
                        // 20% 粒子聚合成星座，80% 粒子随机分布但靠近中心
                        if (i < PARTICLE_COUNT * 0.2) {
                            const shapeFunc = ZodiacShapes[signs[signIndex]];
                            const normPos = shapeFunc(i);
                            // 映射到屏幕中心区域 (0.6倍大小)
                            p.tx = normPos.x * width * 0.6 + width * 0.2 + (Math.random()-0.5)*10;
                            p.ty = normPos.y * height * 0.6 + height * 0.2 + (Math.random()-0.5)*10;
                        } else {
                            // 背景星尘，轻微聚拢
                            p.tx = Math.random() * width;
                            p.ty = Math.random() * height;
                        }
                    } else {
                        // DISPERSED: 完全铺满全屏
                        p.tx = p.baseX;
                        p.ty = p.baseY;
                    }
                });
            }

            function animate(t) {
                ctx.clearRect(0, 0, width, height);
                
                // 状态循环：散开(6s) -> 聚合(6s) -> 散开...
                if (t - lastStateChange > 6000) {
                    lastStateChange = t;
                    if (state === 'DISPERSED') {
                        state = 'GATHERING';
                        signIndex = (signIndex + 1) % signs.length;
                    } else {
                        state = 'DISPERSED';
                        // 重新随机化散开位置，增加自然感
                        particles.forEach(p => { p.baseX = Math.random()*width; p.baseY = Math.random()*height; });
                    }
                    updateTargets();
                }

                particles.forEach(p => {
                    // 1. 平和的插值移动 (Lerp) - 关键在于系数 0.015 (非常慢)
                    // 这创造了"缓慢漂浮"的感觉，而不是弹性物理
                    p.x += (p.tx - p.x) * 0.015;
                    p.y += (p.ty - p.y) * 0.015;

                    // 2. 鼠标排斥 (Repulsion) - 独立叠加
                    const dx = mouse.x - p.x;
                    const dy = mouse.y - p.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < 200) {
                        const force = (200 - dist) / 200;
                        // 甚至鼠标推力也柔和一点
                        p.x -= (dx/dist) * force * 5; 
                        p.y -= (dy/dist) * force * 5;
                    }

                    // 3. 绘制
                    const alpha = 0.3 + Math.random() * 0.3; // 闪烁
                    ctx.beginPath();
                    ctx.fillStyle = `rgba(${p.color.r},${p.color.g},${p.color.b},${alpha})`;
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                });

                requestAnimationFrame(animate);
            }
            animate(0);

            window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
            window.addEventListener('resize', () => { width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; });
        }, []);
        return null;
    };

    // ==========================================
    // 2. 增强版输入组件 (Enhanced Inputs)
    // ==========================================

    // --- 日期输入器 (MM/DD/YYYY 单字段自动格式化) ---
    const DateInput = () => {
        const [value, setValue] = useState('');
        
        const formatDate = (input) => {
            // 移除所有非数字字符
            const numbers = input.replace(/\D/g, '');
            
            if (numbers.length === 0) return '';
            if (numbers.length <= 2) return numbers;
            if (numbers.length <= 4) return `${numbers.slice(0, 2)}/${numbers.slice(2)}`;
            return `${numbers.slice(0, 2)}/${numbers.slice(2, 4)}/${numbers.slice(4, 8)}`;
        };
        
        const handleChange = (e) => {
            const formatted = formatDate(e.target.value);
            // 限制总长度为10 (MM/DD/YYYY)
            if (formatted.replace(/\D/g, '').length <= 8) {
                setValue(formatted);
            }
        };
        
        return (
            <div className="group">
                <label className="text-[10px] uppercase tracking-widest text-gray-500 ml-1 group-focus-within:text-teal-400 transition-colors">
                    Date of Birth (MM / DD / YYYY)
                </label>
                <input 
                    name="date"
                    type="text" 
                    placeholder="MM / DD / YYYY"
                    value={value}
                    onChange={handleChange}
                    maxLength={10}
                    required
                    className="input-glass w-full rounded p-3 text-sm mt-1 placeholder-gray-600" 
                />
            </div>
        );
    };

    // --- 全球城市搜索 (带智能排序和搜索图标) ---
    const CityInput = () => {
        const [query, setQuery] = useState('');
        const [isOpen, setIsOpen] = useState(false);
        
        // 扩充的模拟数据库 (包含主要国际城市)
        const CITIES = [
            "New York, USA", "New Delhi, India", "Newcastle, UK", "New Orleans, USA",
            "London, UK", "Los Angeles, USA", "Las Vegas, USA", "Lisbon, Portugal",
            "Paris, France", "Prague, Czechia", "Perth, Australia",
            "Tokyo, Japan", "Toronto, Canada", "Taipei, Taiwan",
            "Sydney, Australia", "Shanghai, China", "Seoul, South Korea", "Singapore",
            "Berlin, Germany", "Beijing, China", "Bangkok, Thailand", "Barcelona, Spain",
            "Dubai, UAE", "Dublin, Ireland",
            "Rome, Italy", "Rio de Janeiro, Brazil",
            "Moscow, Russia", "Madrid, Spain", "Mexico City, Mexico",
            "Vancouver, Canada", "Vienna, Austria"
        ];

        // 智能排序逻辑：以Query开头的排前面，其他的按字母排
        const filteredCities = useMemo(() => {
            if (!query) return [];
            const lowerQ = query.toLowerCase();
            return CITIES.filter(c => c.toLowerCase().includes(lowerQ))
                .sort((a, b) => {
                    const aStarts = a.toLowerCase().startsWith(lowerQ);
                    const bStarts = b.toLowerCase().startsWith(lowerQ);
                    if (aStarts && !bStarts) return -1; // a 排前
                    if (!aStarts && bStarts) return 1;  // b 排前
                    return a.localeCompare(b); // 否则按字母序
                });
        }, [query]);

        return (
            <div className="relative group">
                <label className="text-[10px] uppercase tracking-widest text-gray-500 ml-1 group-focus-within:text-teal-400 transition-colors">Place of Birth</label>
                <div className="relative mt-1">
                    <input 
                        name="city"
                        type="text" 
                        required 
                        placeholder="Type city (e.g. New York)"
                        className="input-glass w-full rounded p-3 pl-10 text-sm placeholder-gray-600"
                        value={query}
                        onChange={e => { setQuery(e.target.value); setIsOpen(true); }}
                        onBlur={() => setTimeout(() => setIsOpen(false), 200)}
                    />
                    <svg 
                        className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none" 
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                    >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                {isOpen && query.length > 0 && (
                    <div className="absolute top-full left-0 w-full mt-1 glass-panel rounded-lg max-h-48 overflow-y-auto z-50 no-scrollbar">
                        {filteredCities.length > 0 ? filteredCities.map(city => (
                            <div key={city} onClick={() => { setQuery(city); setIsOpen(false); }}
                                 className="p-3 text-sm text-gray-300 hover:bg-white/10 cursor-pointer border-b border-white/5 last:border-0">
                                {city}
                            </div>
                        )) : (
                            <div className="p-3 text-xs text-gray-500 italic">No exact match found in demo DB</div>
                        )}
                    </div>
                )}
            </div>
        );
    };

    // ==========================================
    // 3. 页面逻辑 (Pages)
    // ==========================================

    const LandingPage = ({ onStart }) => (
        <motion.div initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0, scale:1.1, filter:"blur(20px)"}} transition={{duration: 0.8}} className="h-screen flex flex-col items-center justify-center text-center z-10 px-6 relative w-full overflow-hidden">
            <h1 className="font-display font-bold absolute select-none text-outline opacity-10 blur-sm scale-110 pointer-events-none" style={{ fontSize: '15vw' }}>LUMINA</h1>
            <h1 className="font-display font-bold relative z-10 text-transparent bg-clip-text bg-gradient-to-b from-white via-white to-white/50 drop-shadow-[0_0_30px_rgba(255,255,255,0.5)] mb-6" style={{ fontSize: '8vw', lineHeight: '1' }}>LUMINA</h1>
            
            <div className="relative z-10 flex flex-col items-center gap-3 mb-10">
                <div className="h-[1px] w-12 bg-white/30"></div>
                <p className="text-gray-300 text-sm md:text-base tracking-[0.2em] uppercase font-light">The Life Simulator</p>
                <p className="text-white text-lg md:text-2xl font-display font-bold tracking-widest uppercase glow-gold">That Changes Destiny</p>
                <div className="h-[1px] w-12 bg-white/30"></div>
            </div>

            <div className="glass-panel p-6 rounded-2xl max-w-lg mb-12 text-left border-l-2 border-teal-500/50 backdrop-blur-md">
                <h3 className="text-teal-400 text-xs uppercase tracking-widest mb-3 font-bold">System Protocol:</h3>
                <p className="text-gray-300 text-sm leading-relaxed">
                    Initiate a council with your inner archetypes. Your <strong className="text-amber-400">Sun</strong>, <strong className="text-slate-300">Moon</strong>, and <strong className="text-teal-400">Rising</strong> signs await to simulate your timeline.
                </p>
            </div>

            <motion.button whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }} onClick={onStart} className="glass-btn px-16 py-6 rounded-full text-sm font-bold tracking-[0.2em] uppercase text-white shadow-[0_0_30px_rgba(255,255,255,0.05)] border border-white/20">
                Initialize
            </motion.button>
        </motion.div>
    );

    const InputPage = ({ onSubmit }) => {
        const handleSubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = {
                firstName: formData.get('firstName') || '',
                lastName: formData.get('lastName') || '',
                date: formData.get('date') || '',
                time: formData.get('time') || '',
                city: formData.get('city') || ''
            };
            onSubmit(userData);
        };

        return (
            <motion.div initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0, y:-50, filter:"blur(10px)"}} transition={{duration: 0.5}} className="w-full max-w-md z-10 relative">
                 <div className="absolute -top-32 -left-32 w-80 h-80 bg-amber-500/5 rounded-full blur-[100px] pointer-events-none"></div>

                <div className="text-center mb-10">
                    <h2 className="font-display text-2xl font-bold tracking-[0.2em] text-white/90">CALIBRATION</h2>
                    <p className="text-xs text-gray-500 mt-2 uppercase tracking-widest">Enter Celestial Coordinates</p>
                </div>
                
                <form onSubmit={handleSubmit} className="glass-panel p-8 rounded-2xl space-y-6 backdrop-blur-xl">
                    {/* First / Last Name */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="group">
                            <label className="text-[10px] uppercase tracking-widest text-gray-500 ml-1 group-focus-within:text-teal-400 transition-colors">First Name</label>
                            <input name="firstName" type="text" required className="input-glass w-full rounded p-3 text-sm mt-1" />
                        </div>
                        <div className="group">
                            <label className="text-[10px] uppercase tracking-widest text-gray-500 ml-1 group-focus-within:text-teal-400 transition-colors">Last Name</label>
                            <input name="lastName" type="text" required className="input-glass w-full rounded p-3 text-sm mt-1" />
                        </div>
                    </div>
                    
                    {/* Custom Date Input - Single field with auto-formatting */}
                    <DateInput />

                    {/* Time & City */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="group">
                            <label className="text-[10px] uppercase tracking-widest text-gray-500 ml-1 group-focus-within:text-teal-400 transition-colors">Time of Birth</label>
                            <input name="time" type="time" required className="input-glass w-full rounded p-3 text-sm mt-1 text-gray-400" />
                        </div>
                        {/* City Auto-complete with search icon */}
                        <CityInput />
                    </div>

                    <button type="submit" className="glass-btn w-full py-4 mt-6 rounded-xl text-xs uppercase tracking-[0.2em] font-bold text-white shadow-lg">
                        Begin Simulation
                    </button>
                </form>
            </motion.div>
        );
    };

    // Loading 页面 - 调用 API
    const LoadingPage = ({ userData, onComplete, onError }) => {
        useEffect(() => {
            const fetchData = async () => {
                try {
                    const response = await fetch('/api/consult', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData),
                    });
                    
                    if (!response.ok) {
                        throw new Error('API request failed');
                    }
                    
                    const data = await response.json();
                    onComplete(data);
                } catch (error) {
                    console.error('Error:', error);
                    onError(error);
                }
            };
            
            fetchData();
        }, []);
        
        return (
            <motion.div initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}} className="text-center z-10">
                <div className="w-24 h-24 border-t-2 border-white rounded-full animate-spin mx-auto mb-8 opacity-80"></div>
                <div className="font-display text-sm tracking-[0.3em] animate-pulse">ALIGNING STARS</div>
            </motion.div>
        );
    };

    // Dashboard 页面 - 显示 API 返回的数据
    const DashboardPage = ({ data }) => (
         <motion.div initial={{opacity:0}} animate={{opacity:1}} className="w-full max-w-5xl h-screen overflow-hidden z-10 flex items-center justify-center p-6">
            <div className="glass-panel p-12 rounded-3xl text-center border-t border-white/20">
                <h2 className="font-display text-4xl font-bold mb-4 glow-gold">
                    Welcome, {data?.firstName || "Traveler"}
                </h2>
                <p className="text-gray-400 mb-8 uppercase tracking-widest text-xs">Analysis Complete</p>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 my-8">
                    <div className="p-6 bg-white/5 rounded-xl border border-white/5">
                        <p className="text-xs uppercase text-gray-500 mb-2">Sun Sign</p>
                        <p className="text-xl text-amber-300 font-bold">{data?.sunSign || "Calculated"}</p>
                    </div>
                    <div className="p-6 bg-white/5 rounded-xl border border-white/5">
                        <p className="text-xs uppercase text-gray-500 mb-2">Moon Sign</p>
                        <p className="text-xl text-gray-300 font-bold">{data?.moonSign || "Unknown"}</p>
                    </div>
                    <div className="p-6 bg-white/5 rounded-xl border border-white/5">
                        <p className="text-xs uppercase text-gray-500 mb-2">Life Path</p>
                        <p className="text-xl text-teal-300 font-bold">{data?.lifePath || "Unknown"}</p>
                    </div>
                </div>

                <p className="text-gray-400 text-sm leading-relaxed max-w-2xl mx-auto mb-8">
                    {data?.message || "The stars have aligned to reveal your path."}
                </p>
                
                <button onClick={() => window.location.reload()} className="glass-btn px-8 py-3 rounded-full text-xs uppercase font-bold tracking-widest">
                    Restart Session
                </button>
            </div>
        </motion.div>
    );

    const App = () => {
        const [step, setStep] = useState(0);
        const [userData, setUserData] = useState(null);
        const [resultData, setResultData] = useState(null);

        const handleFormSubmit = (data) => {
            setUserData(data);
            setStep(2); // 进入加载状态
        };

        const handleLoadingComplete = (data) => {
            setResultData(data);
            setStep(3); // 进入结果页
        };

        const handleLoadingError = (error) => {
            alert("Connection to the stars failed. Please try again.");
            setStep(1); // 返回输入页
        };

        return (
            <div className="relative w-full h-full flex items-center justify-center">
                <ConstellationBackground />
                <AnimatePresence mode="wait">
                    {step === 0 && <LandingPage key="landing" onStart={() => setStep(1)} />}
                    {step === 1 && <InputPage key="input" onSubmit={handleFormSubmit} />}
                    {step === 2 && <LoadingPage key="loading" userData={userData} onComplete={handleLoadingComplete} onError={handleLoadingError} />}
                    {step === 3 && <DashboardPage key="dashboard" data={resultData} />}
                </AnimatePresence>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body> </html>

